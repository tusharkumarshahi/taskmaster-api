name: Dummy Deploy (emit deployment events)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment name"
        required: true
        default: "production"
      state:
        description: "Deployment status"
        required: true
        type: choice
        options:
          - success
          - failure
          - inactive
  push:
    branches: [ main ]

permissions:
  contents: read
  deployments: write

jobs:
  emit-deployment:
    runs-on: ubuntu-latest
    steps:
      - name: Create deployment + status
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const environment = (context.payload.inputs && context.payload.inputs.environment) || "production";
            const state = (context.payload.inputs && context.payload.inputs.state) || "success";

            // 1) Create a deployment (emits "deployment" webhook event)
            const deploymentResp = await github.rest.repos.createDeployment({
              owner,
              repo,
              ref: context.sha,
              environment,
              required_contexts: [], // allow deployment without status checks
              auto_merge: false,
              description: `Dummy deployment from GitHub Actions: ${state}`,
              transient_environment: false,
              production_environment: environment === "production",
            });

            const deploymentId = deploymentResp.data.id;

            // 2) Create a deployment status (emits "deployment_status" webhook event)
            await github.rest.repos.createDeploymentStatus({
              owner,
              repo,
              deployment_id: deploymentId,
              state, // success | failure | inactive | in_progress | queued | error
              environment,
              log_url: `${context.serverUrl}/${owner}/${repo}/actions/runs/${context.runId}`,
              description: `Dummy deployment status: ${state}`,
              auto_inactive: false,
            });

            core.info(`Created deployment ${deploymentId} with status ${state} in ${environment}`);
