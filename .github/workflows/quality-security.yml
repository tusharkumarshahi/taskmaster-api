name: Code Quality - Lint, Security & Coverage

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
  push:
    branches: main

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: Test & Coverage (MUST RUN FIRST)
  # Fail-fast: If code doesn't compile or tests fail, stop here
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-coverage:
    name: Test & Coverage
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run tests with coverage
        run: |
          echo "ğŸ§ª Running tests with JaCoCo coverage..."
          mvn -B clean verify --no-transfer-progress
          echo "âœ… Tests completed and coverage check passed"

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: madrapps/jacoco-report@v1.6.1
        with:
          paths: ${{ github.workspace }}/target/site/jacoco/jacoco.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 95
          min-coverage-changed-files: 95
          title: 'ğŸ“Š Code Coverage Report'
          update-comment: true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: Checkstyle (Linting)
  # Runs in parallel with Snyk after tests pass
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  checkstyle:
    name: Checkstyle Analysis
    runs-on: ubuntu-latest
    needs: test-coverage  # Wait for tests to pass

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run Checkstyle Lint
        uses: tusharkumarshahi/checkstyle-lint-action@v2
        with:
          checkstyle-config: 'google_checks.xml'
          max-errors: 0
          max-warnings: 300
          fail-on-error: true
          check-only-diff: ${{ github.event_name == 'pull_request' }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: Snyk Security Scan
  # Runs in parallel with Checkstyle after tests pass
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  snyk-security:
    name: Snyk Security Scan
    runs-on: ubuntu-latest
    needs: test-coverage  # Wait for tests to pass
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Build project to resolve dependencies for Snyk
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build project (resolve dependencies)
        run: |
          echo "ğŸ“¦ Building project to resolve dependencies..."
          mvn -B clean compile -DskipTests --no-transfer-progress

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Install dependencies (Snyk CLI and jq)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install Snyk CLI and jq
        run: |
          echo "ğŸ“¦ Installing Snyk CLI..."
          npm install -g snyk
          snyk --version
          echo "ğŸ“¦ Installing jq for JSON parsing..."
          sudo apt-get update -qq && sudo apt-get install -y jq
          jq --version

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Authenticate with Snyk
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Authenticate Snyk
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          if [ -z "$SNYK_TOKEN" ]; then
            echo "âŒ SNYK_TOKEN is not set"
            exit 1
          fi
          snyk auth $SNYK_TOKEN
          echo "âœ… Authenticated with Snyk"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Scan Maven dependencies
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run Snyk test on Maven dependencies
        id: snyk-test
        continue-on-error: true
        env:
          MAVEN_CMD: mvn
        run: |
          echo "ğŸ” Scanning Maven dependencies with Snyk..."
          
          # Remove Maven wrapper files to force Snyk to use system Maven
          rm -f mvnw mvnw.cmd
          echo "âœ… Removed Maven wrapper files"
          
          # Debug: Show what Snyk detects
          echo "ğŸ“‹ Detecting project type..."
          snyk test --print-deps 2>&1 | head -20 || true
          
          # Run Snyk test - exit code 1 means vulnerabilities found (not an error)
          # Exit code 2 means an actual error occurred
          set +e  # Don't exit on non-zero code
          snyk test --json > snyk-report.json
          SNYK_EXIT_CODE=$?
          set -e
          
          echo "ğŸ“Š Snyk exit code: $SNYK_EXIT_CODE"
          echo "   (0=no issues, 1=vulnerabilities found, 2=error)"
          
          # Debug: Show first few lines of report
          echo "ğŸ“„ Snyk report preview:"
          head -20 snyk-report.json || true
          
          # Also generate human-readable HTML report
          npm install -g snyk-to-html || true
          if [ -f snyk-report.json ] && [ -s snyk-report.json ]; then
            cat snyk-report.json | snyk-to-html -o snyk-report.html 2>/dev/null || echo "<!-- HTML report generation failed -->" > snyk-report.html
          fi
          
          # Parse results (handle both single project and multi-project JSON structures)
          if [ -f snyk-report.json ] && [ -s snyk-report.json ]; then
            # Check if JSON is valid
            if jq empty snyk-report.json 2>/dev/null; then
              # Parse as single Maven project
              CRITICAL=$(cat snyk-report.json | jq '[.vulnerabilities[]? | select(.severity=="critical")] | length' 2>/dev/null || echo "0")
              HIGH=$(cat snyk-report.json | jq '[.vulnerabilities[]? | select(.severity=="high")] | length' 2>/dev/null || echo "0")
              MEDIUM=$(cat snyk-report.json | jq '[.vulnerabilities[]? | select(.severity=="medium")] | length' 2>/dev/null || echo "0")
              LOW=$(cat snyk-report.json | jq '[.vulnerabilities[]? | select(.severity=="low")] | length' 2>/dev/null || echo "0")
              TOTAL=$((CRITICAL + HIGH + MEDIUM + LOW))
            else
              echo "âš ï¸ Invalid JSON in snyk-report.json - showing content:"
              cat snyk-report.json | head -50
              CRITICAL=0
              HIGH=0
              MEDIUM=0
              LOW=0
              TOTAL=0
            fi
            
            # Extract top 5 critical/high vulnerabilities with details (only if valid JSON)
            if [ "$TOTAL" -gt 0 ]; then
              echo "detailed_vulns<<EOF" >> $GITHUB_OUTPUT
              cat snyk-report.json | jq -r '
                [.vulnerabilities[]? | select(.severity=="critical" or .severity=="high")] | .[:5] |
                .[] |
                "### [\(.severity | ascii_upcase)] \(.title // .id)\n" +
                "- **Package**: `\(.packageName)@\(.version)`\n" +
                "- **CVE**: \(.identifiers.CVE[0] // "N/A")\n" +
                "- **CVSS Score**: \(.cvssScore // "N/A")\n" +
                "- **Exploit Maturity**: \(.exploitMaturity // "Unknown")\n" +
                "- **Fix**: \(if .fixedIn | length > 0 then "Upgrade to \(.fixedIn | join(", "))" else "No fix available yet" end)\n" +
                "- **Description**: \(.description // "No description")\n"
              ' >> $GITHUB_OUTPUT 2>/dev/null || echo "" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            else
              echo "detailed_vulns=" >> $GITHUB_OUTPUT
            fi
          else
            CRITICAL=0
            HIGH=0
            MEDIUM=0
            LOW=0
            TOTAL=0
            echo "detailed_vulns=" >> $GITHUB_OUTPUT
          fi
          
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ›¡ï¸  Snyk Security Scan Results"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  ğŸ”´ Critical: $CRITICAL"
          echo "  ğŸŸ  High:     $HIGH"
          echo "  ğŸŸ¡ Medium:   $MEDIUM"
          echo "  ğŸŸ¢ Low:      $LOW"
          echo "  ğŸ“Š Total:    $TOTAL"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # Print detailed vulnerability information to logs
          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "ğŸ“‹ Detailed Vulnerability Information:"
            echo ""
            cat snyk-report.json | jq -r '
              [.vulnerabilities[]? | select(.severity=="critical" or .severity=="high")] |
              .[] |
              "[\(.severity | ascii_upcase)] \(.title // .id)\n" +
              "  Package: \(.packageName)@\(.version)\n" +
              "  CVE: \(.identifiers.CVE[0] // "N/A")\n" +
              "  CVSS: \(.cvssScore // "N/A") | Exploit: \(.exploitMaturity // "Unknown")\n" +
              "  Fix: \(if .fixedIn | length > 0 then "Upgrade to \(.fixedIn | join(", "))" else "No fix available" end)\n"
            ' 2>/dev/null || echo "  (Unable to parse vulnerability details)"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "âŒ Critical or High severity vulnerabilities found!"
            echo "   Please fix these vulnerabilities before merging."
            echo "   Download 'snyk-security-report' artifact for full details."
            exit 1
          else
            echo "âœ… No critical or high severity vulnerabilities found"
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Monitor with Snyk (send to dashboard)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Monitor project with Snyk
        continue-on-error: true
        env:
          MAVEN_CMD: mvn
        run: |
          echo "ğŸ“¤ Sending results to Snyk dashboard..."
          snyk monitor \
            --project-name="${{ github.repository }}" \
            || echo "âš ï¸ Monitoring failed, but continuing..."

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Upload Snyk report as artifact
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload Snyk report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: snyk-security-report
          path: |
            snyk-report.json
            snyk-report.html
          retention-days: 30

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Extract top vulnerabilities for PR comment
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Extract top vulnerabilities
        id: top-vulns
        if: always()
        run: |
          # Extract top 5 CRITICAL or HIGH vulnerabilities
          if [ -f snyk-report.json ] && [ -s snyk-report.json ]; then
            if jq empty snyk-report.json 2>/dev/null; then
              TOP_VULNS=$(jq -r '
                [.vulnerabilities[]? | 
                select(.severity == "critical" or .severity == "high") |
                {
                  id: (.identifiers.CVE[0] // .id),
                  title: .title,
                  severity: .severity,
                  package: .packageName,
                  version: .version,
                  fixedIn: (.fixedIn // [] | join(", ")),
                  cvssScore: (.cvssScore // "N/A"),
                  exploitMaturity: (.exploitMaturity // "not-defined")
                }] |
                sort_by(.cvssScore) | reverse |
                .[0:5] |
                map(
                  "**\(.id)** (CVSS: \(.cvssScore)) - \(.severity | ascii_upcase)\n" +
                  "Package: `\(.package)@\(.version)`" +
                  (if .fixedIn != "" then " â†’ Fix: Upgrade to `\(.fixedIn)`" else " â†’ No fix available yet" end) + "\n" +
                  "Exploit Maturity: \(.exploitMaturity)\n" +
                  "\(.title)"
                ) |
                join("\n\n")
              ' snyk-report.json)
              
              echo "$TOP_VULNS" > top-vulns.txt
              
              if [ -s top-vulns.txt ]; then
                echo "has_vulns=true" >> $GITHUB_OUTPUT
              else
                echo "has_vulns=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "has_vulns=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "has_vulns=false" >> $GITHUB_OUTPUT
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Comment Snyk results on PR
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Comment Snyk results on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            const critical = '${{ steps.snyk-test.outputs.critical }}' || '0';
            const high = '${{ steps.snyk-test.outputs.high }}' || '0';
            const medium = '${{ steps.snyk-test.outputs.medium }}' || '0';
            const low = '${{ steps.snyk-test.outputs.low }}' || '0';
            const total = '${{ steps.snyk-test.outputs.total }}' || '0';
            const hasVulns = '${{ steps.top-vulns.outputs.has_vulns }}' === 'true';
            
            let statusEmoji = 'âœ…';
            let statusText = 'Passed';
            if (parseInt(critical) > 0) {
              statusEmoji = 'âŒ';
              statusText = 'Failed - Critical vulnerabilities found';
            } else if (parseInt(high) > 0) {
              statusEmoji = 'âš ï¸';
              statusText = 'Warning - High severity vulnerabilities found';
            }
            
            let comment = `## ğŸ›¡ï¸ Snyk Dependency Security Scan\n\n`;
            comment += `**Status:** ${statusEmoji} ${statusText}\n\n`;
            
            comment += `### Summary\n`;
            comment += `| Severity | Count |\n`;
            comment += `|----------|-------|\n`;
            comment += `| ğŸ”´ Critical | ${critical} |\n`;
            comment += `| ğŸŸ  High | ${high} |\n`;
            comment += `| ğŸŸ¡ Medium | ${medium} |\n`;
            comment += `| ğŸŸ¢ Low | ${low} |\n`;
            comment += `| **Total** | **${total}** |\n\n`;
            
            if (hasVulns && (parseInt(critical) > 0 || parseInt(high) > 0)) {
              let topVulns = '';
              try {
                topVulns = fs.readFileSync('top-vulns.txt', 'utf8').trim();
              } catch (e) {
                topVulns = '_Unable to load vulnerability details_';
              }
              
              comment += `### Top 5 Vulnerabilities\n\n`;
              comment += topVulns + '\n\n';
              
              if (parseInt(critical) + parseInt(high) > 5) {
                comment += `<details>\n`;
                comment += `<summary>ğŸ“„ View all ${parseInt(critical) + parseInt(high)} vulnerabilities</summary>\n\n`;
                comment += `Download the [full Snyk report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) from workflow artifacts.\n`;
                comment += `</details>\n\n`;
              }
              
              comment += `### ğŸ”§ Next Steps\n`;
              comment += `1. Review vulnerabilities above\n`;
              comment += `2. Update dependencies in \`pom.xml\`\n`;
              comment += `3. Run \`mvn versions:display-dependency-updates\` locally\n`;
              comment += `4. Re-run workflow to verify fixes\n\n`;
            } else if (parseInt(total) === 0) {
              comment += `âœ… No vulnerabilities detected in your dependencies.\n\n`;
            } else {
              comment += `â„¹ï¸ ${medium} medium and ${low} low severity issues found. Consider addressing in a follow-up.\n\n`;
            }
            
            comment += `---\n`;
            comment += `ğŸ“„ [Download detailed report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) â€¢ `;
            comment += `ğŸ” [View workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n`;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ğŸ›¡ï¸ Snyk Dependency Security Scan')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Add summary to workflow
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Display security summary
        if: always()
        run: |
          echo "## ğŸ›¡ï¸ Snyk Security Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”´ Critical | ${{ steps.snyk-test.outputs.critical }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸŸ  High | ${{ steps.snyk-test.outputs.high }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸŸ¡ Medium | ${{ steps.snyk-test.outputs.medium }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸŸ¢ Low | ${{ steps.snyk-test.outputs.low }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **${{ steps.snyk-test.outputs.total }}** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.snyk-test.outputs.critical }}" -gt 0 ] || [ "${{ steps.snyk-test.outputs.high }}" -gt 0 ]; then
            echo "**Status:** âŒ Failed - Critical/High vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** âœ… Passed - No critical/high vulnerabilities" >> $GITHUB_STEP_SUMMARY
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 4: SonarQube Analysis
  # Runs after all quality and security checks pass
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  sonar-quality:
    name: SonarQube Analysis
    needs: [test-coverage, checkstyle, snyk-security]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      - name: Build, test, and generate coverage
        run: |
          mvn -B clean verify jacoco:report --batch-mode

      - name: SonarQube analysis (Maven)
        id: sonar
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
          SONAR_ORG: ${{ secrets.SONAR_ORG }}
        run: |
          PR_NUMBER="${{ github.event_name == 'pull_request' && github.event.pull_request.number || '' }}"
          PR_BRANCH="${{ github.head_ref }}"
          PR_BASE="${{ github.base_ref }}"
          EXTRA_ARGS=""
          if [ -n "$SONAR_ORG" ]; then
            EXTRA_ARGS="$EXTRA_ARGS -Dsonar.organization=$SONAR_ORG"
          fi
          if [ -n "$PR_NUMBER" ]; then
            EXTRA_ARGS="$EXTRA_ARGS -Dsonar.pullrequest.key=$PR_NUMBER -Dsonar.pullrequest.branch=$PR_BRANCH -Dsonar.pullrequest.base=$PR_BASE"
          fi
          mvn -B sonar:sonar \
            -Dsonar.projectKey="$SONAR_PROJECT_KEY" \
            -Dsonar.host.url="$SONAR_HOST_URL" \
            -Dsonar.login="$SONAR_TOKEN" \
            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
            -Dsonar.java.binaries=target/classes \
            -Dsonar.scm.provider=git $EXTRA_ARGS

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Wait for Sonar CE task completion
        id: wait-ce
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          TASK_FILE="target/sonar/report-task.txt"
          if [ ! -f "$TASK_FILE" ]; then
            echo "Sonar task file not found at $TASK_FILE"; exit 1;
          fi
          CE_TASK_ID=$(grep 'ceTaskId' "$TASK_FILE" | cut -d'=' -f2)
          echo "CE_TASK_ID=$CE_TASK_ID"
          for i in {1..30}; do
            STATUS=$(curl -s -u "$SONAR_TOKEN:" "${SONAR_HOST_URL}/api/ce/task?id=${CE_TASK_ID}" | jq -r .task.status)
            echo "Status: $STATUS"
            if [ "$STATUS" = "SUCCESS" ]; then break; fi
            if [ "$STATUS" = "FAILED" ]; then echo "Sonar CE failed"; exit 1; fi
            sleep 5
          done

      - name: Fetch coverage from Sonar
        id: sonar-coverage
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
        run: |
          PR_NUMBER="${{ github.event_name == 'pull_request' && github.event.pull_request.number || '' }}"
          if [ -n "$PR_NUMBER" ]; then
            RESP=$(curl -s -u "$SONAR_TOKEN:" "${SONAR_HOST_URL}/api/measures/component?component=${SONAR_PROJECT_KEY}&metricKeys=coverage&pullRequest=${PR_NUMBER}")
          else
            BRANCH="${{ github.ref_name }}"
            RESP=$(curl -s -u "$SONAR_TOKEN:" "${SONAR_HOST_URL}/api/measures/component?component=${SONAR_PROJECT_KEY}&metricKeys=coverage&branch=${BRANCH}")
          fi
          COVERAGE=$(echo "$RESP" | jq -r '.component.measures[0].value // "0.0"')
          echo "coverage=${COVERAGE}" >> "$GITHUB_OUTPUT"
          echo "SonarQube Coverage: ${COVERAGE}%"

      - name: Fetch Quality Gate status
        id: sonar-qg
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
        run: |
          PR_NUMBER="${{ github.event_name == 'pull_request' && github.event.pull_request.number || '' }}"
          if [ -n "$PR_NUMBER" ]; then
            RESP=$(curl -s -u "$SONAR_TOKEN:" "${SONAR_HOST_URL}/api/qualitygates/project_status?projectKey=${SONAR_PROJECT_KEY}&pullRequest=${PR_NUMBER}")
          else
            BRANCH="${{ github.ref_name }}"
            RESP=$(curl -s -u "$SONAR_TOKEN:" "${SONAR_HOST_URL}/api/qualitygates/project_status?projectKey=${SONAR_PROJECT_KEY}&branch=${BRANCH}")
          fi
          STATUS=$(echo "$RESP" | jq -r '.projectStatus.status // "UNKNOWN"')
          SUMMARY=$(echo "$RESP" | jq -r '.projectStatus.conditions[]? | "- " + (.metricKey // "metric") + ": " + (.status // "NA") + " (actual: " + (.actualValue // "n/a") + ", op: " + (.comparator // "?") + ", threshold: " + (.errorThreshold // "n/a") + ")"' | head -5)
          echo "status=$STATUS" >> "$GITHUB_OUTPUT"
          echo "summary<<EOF" >> "$GITHUB_OUTPUT"
          echo "${SUMMARY}" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Fetch top issues (critical/high)
        id: sonar-issues
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
        run: |
          PR_NUMBER="${{ github.event_name == 'pull_request' && github.event.pull_request.number || '' }}"
          QUERY="types=BUG,VULNERABILITY,CODE_SMELL&severities=BLOCKER,CRITICAL,MAJOR&ps=5&s=FILE_LINE"
          if [ -n "$PR_NUMBER" ]; then
            RESP=$(curl -s -u "$SONAR_TOKEN:" "${SONAR_HOST_URL}/api/issues/search?projectKeys=${SONAR_PROJECT_KEY}&pullRequest=${PR_NUMBER}&${QUERY}")
          else
            BRANCH="${{ github.ref_name }}"
            RESP=$(curl -s -u "$SONAR_TOKEN:" "${SONAR_HOST_URL}/api/issues/search?projectKeys=${SONAR_PROJECT_KEY}&branch=${BRANCH}&${QUERY}")
          fi
          TOP=$(echo "$RESP" | jq -r '.issues[]? | "- [" + (.severity // "NA") + "] " + (.message // "No message") + " (" + ((.component | split(":"))[-1] // "?") + ":" + (((.line // "")) | tostring) + ")"' | head -5)
          echo "list<<EOF" >> "$GITHUB_OUTPUT"
          echo "${TOP}" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Comment Sonar details on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          script: |
            const coverage = '${{ steps.sonar-coverage.outputs.coverage }}';
            const qgStatus = '${{ steps.sonar-qg.outputs.status }}';
            const qgSummary = `${{ steps.sonar-qg.outputs.summary }}`;
            const issues = `${{ steps.sonar-issues.outputs.list }}`;
            const projectKey = process.env.SONAR_PROJECT_KEY || 'project';
            const host = process.env.SONAR_HOST_URL || 'https://sonarcloud.io';
            const pr = context.issue.number;
            const baseUrl = `${host}/project/overview?id=${projectKey}`;
            const prUrl = `${baseUrl}&pullRequest=${pr}`;
            const issuesUrl = `${host}/project/issues?id=${projectKey}&pullRequest=${pr}`;
            const measuresUrl = `${host}/component_measures?id=${projectKey}&metric=coverage&pullRequest=${pr}`;

            const qgBlock = qgSummary && qgSummary.trim() ? `\n${qgSummary}` : '\n- (no conditions reported)';
            const issueBlock = issues && issues.trim() ? issues : '- No blocker/critical/major issues found';

            const body = `## ğŸ” SonarQube Analysis\n\n` +
              `**Coverage:** ${coverage}%\n` +
              `**Quality Gate:** ${qgStatus || 'UNKNOWN'}\n` +
              `\n**Quality Gate details:**${qgBlock}\n` +
              `\n**Top issues (BLOCKER/CRITICAL/MAJOR):**\n${issueBlock}\n` +
              `\n**Links:**\n` +
              `- [PR Overview](${prUrl})\n` +
              `- [PR Issues](${issuesUrl})\n` +
              `- [Coverage Measures](${measuresUrl})\n` +
              `\n---\n` +
              `_Source: SonarQube analysis for this PR._`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

      - name: Display Sonar summary
        run: |
          echo "## ğŸ” SonarQube Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Coverage:** ${{ steps.sonar-coverage.outputs.coverage }}%" >> $GITHUB_STEP_SUMMARY
          echo "**Quality Gate:** ${{ steps.sonar-qg.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Quality Gate Details:**" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.sonar-qg.outputs.summary }}" >> $GITHUB_STEP_SUMMARY

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Enforce Quality Gate - FAIL pipeline if gate fails
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Enforce Quality Gate
        if: steps.sonar-qg.outputs.status != 'OK'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ Quality Gate FAILED!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Status: ${{ steps.sonar-qg.outputs.status }}"
          echo ""
          echo "Quality Gate conditions not met. Please fix the issues before merging:"
          echo "${{ steps.sonar-qg.outputs.summary }}"
          echo ""
          echo "ğŸ”— View detailed report in SonarQube dashboard"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          exit 1
