name: Code Quality - Lint, Security & Coverage

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
  push:
    branches: main

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: Checkstyle (Linting)
  # Runs in parallel with Snyk
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  checkstyle:
    name: Checkstyle Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run Checkstyle Lint
        uses: tusharkumarshahi/checkstyle-lint-action@v2
        with:
          checkstyle-config: 'google_checks.xml'
          max-errors: 0
          max-warnings: 300
          fail-on-error: true
          check-only-diff: ${{ github.event_name == 'pull_request' }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: Snyk Security Scan (NEW!)
  # Runs in parallel with Checkstyle
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  snyk-security:
    name: Snyk Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Install Snyk CLI
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install Snyk CLI
        run: |
          echo "ğŸ“¦ Installing Snyk CLI..."
          npm install -g snyk
          snyk --version

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Authenticate with Snyk
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Authenticate Snyk
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          if [ -z "$SNYK_TOKEN" ]; then
            echo "âŒ SNYK_TOKEN is not set"
            exit 1
          fi
          snyk auth $SNYK_TOKEN
          echo "âœ… Authenticated with Snyk"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Scan Maven dependencies
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run Snyk test on Maven dependencies
        id: snyk-test
        continue-on-error: true
        run: |
          echo "ğŸ” Scanning Maven dependencies with Snyk..."
          
          # Run Snyk test for Maven (scans pom.xml)
          # Use --command=mvn to force system Maven instead of wrapper
          snyk test \
            --command=mvn \
            --severity-threshold=high \
            --json \
            --file=pom.xml \
            > snyk-report.json || true
          
          # Also generate human-readable HTML report
          npm install -g snyk-to-html || true
          snyk test \
            --command=mvn \
            --severity-threshold=low \
            --file=pom.xml \
            --json \
            | snyk-to-html -o snyk-report.html 2>/dev/null || echo "<!-- HTML report generation failed -->" > snyk-report.html
          
          # Parse results
          if [ -f snyk-report.json ]; then
            CRITICAL=$(cat snyk-report.json | jq '[.vulnerabilities[]? | select(.severity=="critical")] | length' 2>/dev/null || echo "0")
            HIGH=$(cat snyk-report.json | jq '[.vulnerabilities[]? | select(.severity=="high")] | length' 2>/dev/null || echo "0")
            MEDIUM=$(cat snyk-report.json | jq '[.vulnerabilities[]? | select(.severity=="medium")] | length' 2>/dev/null || echo "0")
            LOW=$(cat snyk-report.json | jq '[.vulnerabilities[]? | select(.severity=="low")] | length' 2>/dev/null || echo "0")
            TOTAL=$((CRITICAL + HIGH + MEDIUM + LOW))
            
            # Extract top 5 critical/high vulnerabilities with details
            echo "detailed_vulns<<EOF" >> $GITHUB_OUTPUT
            cat snyk-report.json | jq -r '
              [.vulnerabilities[]? | select(.severity=="critical" or .severity=="high")] | 
              .[:5] | 
              .[] | 
              "### [\(.severity | ascii_upcase)] \(.title // .id)\n" +
              "- **Package**: `\(.packageName)@\(.version)`\n" +
              "- **CVE**: \(.identifiers.CVE[0] // "N/A")\n" +
              "- **CVSS Score**: \(.cvssScore // "N/A")\n" +
              "- **Exploit Maturity**: \(.exploitMaturity // "Unknown")\n" +
              "- **Fix**: \(if .fixedIn | length > 0 then "Upgrade to \(.fixedIn | join(", "))" else "No fix available yet" end)\n" +
              "- **Description**: \(.description // "No description")\n"
            ' >> $GITHUB_OUTPUT || echo "" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            CRITICAL=0
            HIGH=0
            MEDIUM=0
            LOW=0
            TOTAL=0
            echo "detailed_vulns=" >> $GITHUB_OUTPUT
          fi
          
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ›¡ï¸  Snyk Security Scan Results"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  ğŸ”´ Critical: $CRITICAL"
          echo "  ğŸŸ  High:     $HIGH"
          echo "  ğŸŸ¡ Medium:   $MEDIUM"
          echo "  ğŸŸ¢ Low:      $LOW"
          echo "  ğŸ“Š Total:    $TOTAL"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # Print detailed vulnerability information to logs
          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "ğŸ“‹ Detailed Vulnerability Information:"
            echo ""
            cat snyk-report.json | jq -r '
              [.vulnerabilities[]? | select(.severity=="critical" or .severity=="high")] | 
              .[] | 
              "[\(.severity | ascii_upcase)] \(.title // .id)\n" +
              "  Package: \(.packageName)@\(.version)\n" +
              "  CVE: \(.identifiers.CVE[0] // "N/A")\n" +
              "  CVSS: \(.cvssScore // "N/A") | Exploit: \(.exploitMaturity // "Unknown")\n" +
              "  Fix: \(if .fixedIn | length > 0 then "Upgrade to \(.fixedIn | join(", "))" else "No fix available" end)\n"
            ' || true
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "âŒ Critical or High severity vulnerabilities found!"
            echo "   Please fix these vulnerabilities before merging."
            echo "   Download 'snyk-security-report' artifact for full details."
            exit 1
          else
            echo "âœ… No critical or high severity vulnerabilities found"
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Monitor with Snyk (send to dashboard)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Monitor project with Snyk
        continue-on-error: true
        run: |
          echo "ğŸ“¤ Sending results to Snyk dashboard..."
          snyk monitor \
            --command=mvn \
            --project-name="${{ github.repository }}" \
            --file=pom.xml \
            || echo "âš ï¸ Monitoring failed, but continuing..."

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Upload Snyk report as artifact
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload Snyk report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: snyk-security-report
          path: |
            snyk-report.json
            snyk-report.html
          retention-days: 30

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Comment Snyk results on PR
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Comment Snyk results on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const critical = '${{ steps.snyk-test.outputs.critical }}' || '0';
            const high = '${{ steps.snyk-test.outputs.high }}' || '0';
            const medium = '${{ steps.snyk-test.outputs.medium }}' || '0';
            const low = '${{ steps.snyk-test.outputs.low }}' || '0';
            const total = '${{ steps.snyk-test.outputs.total }}' || '0';
            const detailedVulns = `${{ steps.snyk-test.outputs.detailed_vulns }}`;
            
            const hasIssues = parseInt(critical) > 0 || parseInt(high) > 0;
            const statusEmoji = hasIssues ? 'âŒ' : 'âœ…';
            const statusText = hasIssues ? 'FAILED - Action Required' : 'PASSED';
            
            let commentBody = `## ğŸ›¡ï¸ Snyk Security Scan\n\n`;
            commentBody += `### ${statusEmoji} Status: ${statusText}\n\n`;
            
            commentBody += `| Severity | Count |\n`;
            commentBody += `|----------|-------|\n`;
            commentBody += `| ğŸ”´ Critical | **${critical}** |\n`;
            commentBody += `| ğŸŸ  High | **${high}** |\n`;
            commentBody += `| ğŸŸ¡ Medium | ${medium} |\n`;
            commentBody += `| ğŸŸ¢ Low | ${low} |\n`;
            commentBody += `| **Total** | **${total}** |\n\n`;
            
            if (hasIssues) {
              commentBody += `### âš ï¸ Action Required\n\n`;
              commentBody += `Critical or High severity vulnerabilities detected in your dependencies.\n\n`;
              
              // Add detailed vulnerability information if available
              if (detailedVulns && detailedVulns.trim()) {
                commentBody += `<details>\n<summary>ğŸ“‹ Top Critical/High Vulnerabilities (Click to expand)</summary>\n\n`;
                commentBody += detailedVulns;
                commentBody += `\n</details>\n\n`;
              }
              
              commentBody += `**Next Steps:**\n`;
              commentBody += `1. Review the [Snyk Dashboard](https://app.snyk.io) for detailed vulnerability information\n`;
              commentBody += `2. Download the full security report from workflow artifacts (JSON + HTML)\n`;
              commentBody += `3. Update vulnerable dependencies:\n`;
              commentBody += `   \`\`\`bash\n`;
              commentBody += `   mvn versions:display-dependency-updates\n`;
              commentBody += `   # Update dependencies in pom.xml\n`;
              commentBody += `   \`\`\`\n`;
              commentBody += `4. Re-run this workflow to verify fixes\n\n`;
            } else {
              commentBody += `âœ… No critical or high severity vulnerabilities detected.\n\n`;
              if (parseInt(medium) > 0 || parseInt(low) > 0) {
                commentBody += `â„¹ï¸ ${medium} medium and ${low} low severity issues found. Consider addressing these in a follow-up PR.\n\n`;
              }
            }
            
            commentBody += `<details>\n`;
            commentBody += `<summary>ğŸ“š About Snyk Security Scanning</summary>\n\n`;
            commentBody += `Snyk scans your Maven dependencies (\`pom.xml\`) for known security vulnerabilities using:\n`;
            commentBody += `- CVE database (Common Vulnerabilities and Exposures)\n`;
            commentBody += `- Snyk's proprietary vulnerability database\n`;
            commentBody += `- Real-time threat intelligence\n\n`;
            commentBody += `**Severity Levels:**\n`;
            commentBody += `- ğŸ”´ **Critical**: Immediate action required\n`;
            commentBody += `- ğŸŸ  **High**: Should be fixed before merging\n`;
            commentBody += `- ğŸŸ¡ **Medium**: Fix in next sprint\n`;
            commentBody += `- ğŸŸ¢ **Low**: Address when convenient\n`;
            commentBody += `</details>\n\n`;
            
            commentBody += `---\n`;
            commentBody += `_ğŸ” Scanned with [Snyk](https://snyk.io) | Threshold: High/Critical_`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Add summary to workflow
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Display security summary
        if: always()
        run: |
          echo "## ğŸ›¡ï¸ Snyk Security Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”´ Critical | ${{ steps.snyk-test.outputs.critical }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸŸ  High | ${{ steps.snyk-test.outputs.high }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸŸ¡ Medium | ${{ steps.snyk-test.outputs.medium }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸŸ¢ Low | ${{ steps.snyk-test.outputs.low }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **${{ steps.snyk-test.outputs.total }}** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.snyk-test.outputs.critical }}" -gt 0 ] || [ "${{ steps.snyk-test.outputs.high }}" -gt 0 ]; then
            echo "**Status:** âŒ Failed - Critical/High vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** âœ… Passed - No critical/high vulnerabilities" >> $GITHUB_STEP_SUMMARY
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: Test & Coverage
  # Only runs if both Checkstyle AND Snyk pass
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-coverage:
    name: Test & Coverage
    needs: [checkstyle, snyk-security]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'
      
      - name: Run tests with coverage
        id: test
        run: |
          echo "ğŸ§ª Running tests with code coverage..."
          mvn clean test jacoco:report verify --batch-mode
      
      - name: Calculate coverage from JaCoCo XML
        id: coverage
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Calculating Code Coverage"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          COVERAGE_REPORT="target/site/jacoco/jacoco.xml"
          
          if [ ! -f "$COVERAGE_REPORT" ]; then
            echo "âŒ Coverage report not found at $COVERAGE_REPORT"
            exit 1
          fi
          
          MISSED=$(grep -oP '<counter type="LINE".*?missed="\K[0-9]+' "$COVERAGE_REPORT" | tail -1)
          COVERED=$(grep -oP '<counter type="LINE".*?covered="\K[0-9]+' "$COVERAGE_REPORT" | tail -1)
          
          TOTAL=$((MISSED + COVERED))
          
          if [ $TOTAL -eq 0 ]; then
            PERCENTAGE=0
            echo "âš ï¸  No code to analyze"
          else
            PERCENTAGE=$(awk "BEGIN {printf \"%.2f\", ($COVERED / $TOTAL) * 100}")
          fi
          
          THRESHOLD=70
          
          if (( $(echo "$PERCENTAGE >= 80" | bc -l) )); then
            STATUS_EMOJI="âœ…"
            STATUS_TEXT="Excellent"
            STATUS_COLOR="ğŸŸ¢"
          elif (( $(echo "$PERCENTAGE >= 60" | bc -l) )); then
            STATUS_EMOJI="ğŸ“Š"
            STATUS_TEXT="Good"
            STATUS_COLOR="ğŸŸ¡"
          elif (( $(echo "$PERCENTAGE >= 40" | bc -l) )); then
            STATUS_EMOJI="âš ï¸"
            STATUS_TEXT="Needs Improvement"
            STATUS_COLOR="ğŸŸ "
          else
            STATUS_EMOJI="âŒ"
            STATUS_TEXT="Poor"
            STATUS_COLOR="ğŸ”´"
          fi
          
          echo ""
          echo "ğŸ“ˆ Coverage Metrics:"
          echo "  Lines Covered:    $COVERED"
          echo "  Lines Missed:     $MISSED"
          echo "  Total Lines:      $TOTAL"
          echo "  Coverage:         $PERCENTAGE%"
          echo ""
          echo "$STATUS_COLOR Status: $STATUS_TEXT ($STATUS_EMOJI)"
          echo "  Threshold:        $THRESHOLD%"
          
          if (( $(echo "$PERCENTAGE >= $THRESHOLD" | bc -l) )); then
            echo "  Result:           âœ… Passed"
            THRESHOLD_PASSED=true
          else
            echo "  Result:           âŒ Failed"
            THRESHOLD_PASSED=false
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          echo "percentage=$PERCENTAGE" >> $GITHUB_OUTPUT
          echo "covered=$COVERED" >> $GITHUB_OUTPUT
          echo "missed=$MISSED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "status_emoji=$STATUS_EMOJI" >> $GITHUB_OUTPUT
          echo "status_text=$STATUS_TEXT" >> $GITHUB_OUTPUT
          echo "threshold_passed=$THRESHOLD_PASSED" >> $GITHUB_OUTPUT
      
      - name: Generate coverage badge
        uses: cicirello/jacoco-badge-generator@v2
        with:
          jacoco-csv-file: target/site/jacoco/jacoco.csv
          badges-directory: .github/badges
          generate-branches-badge: true
          generate-coverage-badge: true
      
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: target/site/jacoco/
          retention-days: 7
      
      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const covered = '${{ steps.coverage.outputs.covered }}';
            const missed = '${{ steps.coverage.outputs.missed }}';
            const total = '${{ steps.coverage.outputs.total }}';
            const percentage = '${{ steps.coverage.outputs.percentage }}';
            const statusEmoji = '${{ steps.coverage.outputs.status_emoji }}';
            const statusText = '${{ steps.coverage.outputs.status_text }}';
            
            let commentBody = `## ğŸ“Š Code Coverage Report\n\n`;
            commentBody += `### ${statusEmoji} Coverage: ${percentage}% - ${statusText}\n\n`;
            commentBody += `| Metric | Value |\n`;
            commentBody += `|--------|-------|\n`;
            commentBody += `| **Coverage** | **${percentage}%** |\n`;
            commentBody += `| Lines Covered | ${covered} |\n`;
            commentBody += `| Lines Missed | ${missed} |\n`;
            commentBody += `| Total Lines | ${total} |\n`;
            commentBody += `| Threshold | 70% |\n`;
            commentBody += `| Status | ${'${{ steps.coverage.outputs.threshold_passed }}' === 'true' ? 'âœ… Passed' : 'âŒ Failed'} |\n\n`;
            
            commentBody += `<details>\n`;
            commentBody += `<summary>ğŸ“ˆ Coverage Guidelines</summary>\n\n`;
            commentBody += `| Coverage | Status | Description |\n`;
            commentBody += `|----------|--------|-------------|\n`;
            commentBody += `| 80%+ | ğŸŸ¢ Excellent | Well-tested code |\n`;
            commentBody += `| 60-80% | ğŸŸ¡ Good | Acceptable coverage |\n`;
            commentBody += `| 40-60% | ğŸŸ  Fair | Needs improvement |\n`;
            commentBody += `| <40% | ğŸ”´ Poor | Insufficient testing |\n`;
            commentBody += `</details>\n\n`;
            commentBody += `---\n`;
            commentBody += `_Coverage calculated using JaCoCo_`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });
      
      - name: Display coverage summary
        run: |
          echo "## ğŸ“Š Code Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Coverage:** ${{ steps.coverage.outputs.percentage }}% ${{ steps.coverage.outputs.status_emoji }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.coverage.outputs.status_text }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lines Covered | ${{ steps.coverage.outputs.covered }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lines Missed | ${{ steps.coverage.outputs.missed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Total Lines | ${{ steps.coverage.outputs.total }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Coverage %** | **${{ steps.coverage.outputs.percentage }}%** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Threshold:** 70%" >> $GITHUB_STEP_SUMMARY
          echo "**Result:** ${{ steps.coverage.outputs.threshold_passed == 'true' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 4: SonarQube Analysis
  # Only runs if all previous checks pass
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  sonar-quality:
    name: SonarQube Analysis
    needs: test-coverage
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      - name: Build, test, and generate coverage
        run: |
          mvn -B clean verify jacoco:report --batch-mode

      - name: SonarQube analysis (Maven)
        id: sonar
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
          SONAR_ORG: ${{ secrets.SONAR_ORG }}
        run: |
          PR_NUMBER="${{ github.event_name == 'pull_request' && github.event.pull_request.number || '' }}"
          PR_BRANCH="${{ github.head_ref }}"
          PR_BASE="${{ github.base_ref }}"
          EXTRA_ARGS=""
          if [ -n "$SONAR_ORG" ]; then
            EXTRA_ARGS="$EXTRA_ARGS -Dsonar.organization=$SONAR_ORG"
          fi
          if [ -n "$PR_NUMBER" ]; then
            EXTRA_ARGS="$EXTRA_ARGS -Dsonar.pullrequest.key=$PR_NUMBER -Dsonar.pullrequest.branch=$PR_BRANCH -Dsonar.pullrequest.base=$PR_BASE"
          fi
          mvn -B sonar:sonar \
            -Dsonar.projectKey="$SONAR_PROJECT_KEY" \
            -Dsonar.host.url="$SONAR_HOST_URL" \
            -Dsonar.login="$SONAR_TOKEN" \
            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
            -Dsonar.java.binaries=target/classes \
            -Dsonar.scm.provider=git $EXTRA_ARGS

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Wait for Sonar CE task completion
        id: wait-ce
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          TASK_FILE="target/sonar/report-task.txt"
          if [ ! -f "$TASK_FILE" ]; then
            echo "Sonar task file not found at $TASK_FILE"; exit 1;
          fi
          CE_TASK_ID=$(grep 'ceTaskId' "$TASK_FILE" | cut -d'=' -f2)
          echo "CE_TASK_ID=$CE_TASK_ID"
          for i in {1..30}; do
            STATUS=$(curl -s -u "$SONAR_TOKEN:" "${SONAR_HOST_URL}/api/ce/task?id=${CE_TASK_ID}" | jq -r .task.status)
            echo "Status: $STATUS"
            if [ "$STATUS" = "SUCCESS" ]; then break; fi
            if [ "$STATUS" = "FAILED" ]; then echo "Sonar CE failed"; exit 1; fi
            sleep 5
          done

      - name: Fetch coverage from Sonar
        id: sonar-coverage
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
        run: |
          PR_NUMBER="${{ github.event_name == 'pull_request' && github.event.pull_request.number || '' }}"
          if [ -n "$PR_NUMBER" ]; then
            RESP=$(curl -s -u "$SONAR_TOKEN:" "${SONAR_HOST_URL}/api/measures/component?component=${SONAR_PROJECT_KEY}&metricKeys=coverage&pullRequest=${PR_NUMBER}")
          else
            BRANCH="${{ github.ref_name }}"
            RESP=$(curl -s -u "$SONAR_TOKEN:" "${SONAR_HOST_URL}/api/measures/component?component=${SONAR_PROJECT_KEY}&metricKeys=coverage&branch=${BRANCH}")
          fi
          COVERAGE=$(echo "$RESP" | jq -r '.component.measures[0].value // "0.0"')
          echo "coverage=${COVERAGE}" >> "$GITHUB_OUTPUT"
          echo "SonarQube Coverage: ${COVERAGE}%"

      - name: Fetch Quality Gate status
        id: sonar-qg
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
        run: |
          PR_NUMBER="${{ github.event_name == 'pull_request' && github.event.pull_request.number || '' }}"
          if [ -n "$PR_NUMBER" ]; then
            RESP=$(curl -s -u "$SONAR_TOKEN:" "${SONAR_HOST_URL}/api/qualitygates/project_status?projectKey=${SONAR_PROJECT_KEY}&pullRequest=${PR_NUMBER}")
          else
            BRANCH="${{ github.ref_name }}"
            RESP=$(curl -s -u "$SONAR_TOKEN:" "${SONAR_HOST_URL}/api/qualitygates/project_status?projectKey=${SONAR_PROJECT_KEY}&branch=${BRANCH}")
          fi
          STATUS=$(echo "$RESP" | jq -r '.projectStatus.status // "UNKNOWN"')
          SUMMARY=$(echo "$RESP" | jq -r '.projectStatus.conditions[]? | "- " + (.metricKey // "metric") + ": " + (.status // "NA") + " (actual: " + (.actualValue // "n/a") + ", op: " + (.comparator // "?") + ", threshold: " + (.errorThreshold // "n/a") + ")"' | head -5)
          echo "status=$STATUS" >> "$GITHUB_OUTPUT"
          echo "summary<<EOF" >> "$GITHUB_OUTPUT"
          echo "${SUMMARY}" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Fetch top issues (critical/high)
        id: sonar-issues
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
        run: |
          PR_NUMBER="${{ github.event_name == 'pull_request' && github.event.pull_request.number || '' }}"
          QUERY="types=BUG,VULNERABILITY,CODE_SMELL&severities=BLOCKER,CRITICAL,MAJOR&ps=5&s=FILE_LINE"
          if [ -n "$PR_NUMBER" ]; then
            RESP=$(curl -s -u "$SONAR_TOKEN:" "${SONAR_HOST_URL}/api/issues/search?projectKeys=${SONAR_PROJECT_KEY}&pullRequest=${PR_NUMBER}&${QUERY}")
          else
            BRANCH="${{ github.ref_name }}"
            RESP=$(curl -s -u "$SONAR_TOKEN:" "${SONAR_HOST_URL}/api/issues/search?projectKeys=${SONAR_PROJECT_KEY}&branch=${BRANCH}&${QUERY}")
          fi
          TOP=$(echo "$RESP" | jq -r '.issues[]? | "- [" + (.severity // "NA") + "] " + (.message // "No message") + " (" + ((.component | split(":"))[-1] // "?") + ":" + (((.line // "")) | tostring) + ")"' | head -5)
          echo "list<<EOF" >> "$GITHUB_OUTPUT"
          echo "${TOP}" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Comment Sonar details on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          script: |
            const coverage = '${{ steps.sonar-coverage.outputs.coverage }}';
            const qgStatus = '${{ steps.sonar-qg.outputs.status }}';
            const qgSummary = `${{ steps.sonar-qg.outputs.summary }}`;
            const issues = `${{ steps.sonar-issues.outputs.list }}`;
            const projectKey = process.env.SONAR_PROJECT_KEY || 'project';
            const host = process.env.SONAR_HOST_URL || 'https://sonarcloud.io';
            const pr = context.issue.number;
            const baseUrl = `${host}/project/overview?id=${projectKey}`;
            const prUrl = `${baseUrl}&pullRequest=${pr}`;
            const issuesUrl = `${host}/project/issues?id=${projectKey}&pullRequest=${pr}`;
            const measuresUrl = `${host}/component_measures?id=${projectKey}&metric=coverage&pullRequest=${pr}`;

            const qgBlock = qgSummary && qgSummary.trim() ? `\n${qgSummary}` : '\n- (no conditions reported)';
            const issueBlock = issues && issues.trim() ? issues : '- No blocker/critical/major issues found';

            const body = `## ğŸ” SonarQube Analysis\n\n` +
              `**Coverage:** ${coverage}%\n` +
              `**Quality Gate:** ${qgStatus || 'UNKNOWN'}\n` +
              `\n**Quality Gate details:**${qgBlock}\n` +
              `\n**Top issues (BLOCKER/CRITICAL/MAJOR):**\n${issueBlock}\n` +
              `\n**Links:**\n` +
              `- [PR Overview](${prUrl})\n` +
              `- [PR Issues](${issuesUrl})\n` +
              `- [Coverage Measures](${measuresUrl})\n` +
              `\n---\n` +
              `_Source: SonarQube analysis for this PR._`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

      - name: Display Sonar summary
        run: |
          echo "## ğŸ” SonarQube Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Coverage:** ${{ steps.sonar-coverage.outputs.coverage }}%" >> $GITHUB_STEP_SUMMARY
          echo "**Quality Gate:** ${{ steps.sonar-qg.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Quality Gate Details:**" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.sonar-qg.outputs.summary }}" >> $GITHUB_STEP_SUMMARY
