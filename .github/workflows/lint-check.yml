name: Code Quality - Lint Check

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
  push:
    branches: main

jobs:
  checkstyle:
    name: Checkstyle Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for diff checking

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run Checkstyle Lint
        uses: tusharkumarshahi/checkstyle-lint-action@v2
        with:
          checkstyle-config: 'google_checks.xml'
          max-errors: 0
          max-warnings: 300
          fail-on-error: true
          check-only-diff: ${{ github.event_name == 'pull_request' }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

  test-coverage:
    name: Test & Coverage
    needs: checkstyle
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'
      
      - name: Run tests with coverage
        id: test
        run: |
          echo "ğŸ§ª Running tests with code coverage..."
          mvn clean test jacoco:report verify --batch-mode
      
      - name: Calculate coverage from JaCoCo XML
        id: coverage
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Calculating Code Coverage"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          COVERAGE_REPORT="target/site/jacoco/jacoco.xml"
          
          if [ ! -f "$COVERAGE_REPORT" ]; then
            echo "âŒ Coverage report not found at $COVERAGE_REPORT"
            exit 1
          fi
          
          # Parse JaCoCo XML to get root-level LINE counters (last occurrence)
          MISSED=$(grep -oP '<counter type="LINE".*?missed="\K[0-9]+' "$COVERAGE_REPORT" | tail -1)
          COVERED=$(grep -oP '<counter type="LINE".*?covered="\K[0-9]+' "$COVERAGE_REPORT" | tail -1)
          
          TOTAL=$((MISSED + COVERED))
          
          if [ $TOTAL -eq 0 ]; then
            PERCENTAGE=0
            echo "âš ï¸  No code to analyze"
          else
            PERCENTAGE=$(awk "BEGIN {printf \"%.2f\", ($COVERED / $TOTAL) * 100}")
          fi
          
          THRESHOLD=70
          
          if (( $(echo "$PERCENTAGE >= 80" | bc -l) )); then
            STATUS_EMOJI="âœ…"
            STATUS_TEXT="Excellent"
            STATUS_COLOR="ğŸŸ¢"
          elif (( $(echo "$PERCENTAGE >= 60" | bc -l) )); then
            STATUS_EMOJI="ğŸ“Š"
            STATUS_TEXT="Good"
            STATUS_COLOR="ğŸŸ¡"
          elif (( $(echo "$PERCENTAGE >= 40" | bc -l) )); then
            STATUS_EMOJI="âš ï¸"
            STATUS_TEXT="Needs Improvement"
            STATUS_COLOR="ğŸŸ "
          else
            STATUS_EMOJI="âŒ"
            STATUS_TEXT="Poor"
            STATUS_COLOR="ğŸ”´"
          fi
          
          echo ""
          echo "ğŸ“ˆ Coverage Metrics:"
          echo "  Lines Covered:    $COVERED"
          echo "  Lines Missed:     $MISSED"
          echo "  Total Lines:      $TOTAL"
          echo "  Coverage:         $PERCENTAGE%"
          echo ""
          echo "$STATUS_COLOR Status: $STATUS_TEXT ($STATUS_EMOJI)"
          echo "  Threshold:        $THRESHOLD%"
          
          if (( $(echo "$PERCENTAGE >= $THRESHOLD" | bc -l) )); then
            echo "  Result:           âœ… Passed"
            THRESHOLD_PASSED=true
          else
            echo "  Result:           âŒ Failed"
            THRESHOLD_PASSED=false
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          echo "percentage=$PERCENTAGE" >> $GITHUB_OUTPUT
          echo "covered=$COVERED" >> $GITHUB_OUTPUT
          echo "missed=$MISSED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "status_emoji=$STATUS_EMOJI" >> $GITHUB_OUTPUT
          echo "status_text=$STATUS_TEXT" >> $GITHUB_OUTPUT
          echo "threshold_passed=$THRESHOLD_PASSED" >> $GITHUB_OUTPUT
      
      - name: Generate coverage badge
        uses: cicirello/jacoco-badge-generator@v2
        with:
          jacoco-csv-file: target/site/jacoco/jacoco.csv
          badges-directory: .github/badges
          generate-branches-badge: true
          generate-coverage-badge: true
      
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: target/site/jacoco/
          retention-days: 7
      
      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const covered = '${{ steps.coverage.outputs.covered }}';
            const missed = '${{ steps.coverage.outputs.missed }}';
            const total = '${{ steps.coverage.outputs.total }}';
            const percentage = '${{ steps.coverage.outputs.percentage }}';
            const statusEmoji = '${{ steps.coverage.outputs.status_emoji }}';
            const statusText = '${{ steps.coverage.outputs.status_text }}';
            
            let commentBody = `## ğŸ“Š Code Coverage Report\n\n`;
            commentBody += `### ${statusEmoji} Coverage: ${percentage}% - ${statusText}\n\n`;
            commentBody += `| Metric | Value |\n`;
            commentBody += `|--------|-------|\n`;
            commentBody += `| **Coverage** | **${percentage}%** |\n`;
            commentBody += `| Lines Covered | ${covered} |\n`;
            commentBody += `| Lines Missed | ${missed} |\n`;
            commentBody += `| Total Lines | ${total} |\n`;
            commentBody += `| Threshold | 70% |\n`;
            commentBody += `| Status | ${'${{ steps.coverage.outputs.threshold_passed }}' === 'true' ? 'âœ… Passed' : 'âŒ Failed'} |\n\n`;
            
            commentBody += `<details>\n`;
            commentBody += `<summary>ğŸ“ˆ Coverage Guidelines</summary>\n\n`;
            commentBody += `| Coverage | Status | Description |\n`;
            commentBody += `|----------|--------|-------------|\n`;
            commentBody += `| 80%+ | ğŸŸ¢ Excellent | Well-tested code |\n`;
            commentBody += `| 60-80% | ğŸŸ¡ Good | Acceptable coverage |\n`;
            commentBody += `| 40-60% | ğŸŸ  Fair | Needs improvement |\n`;
            commentBody += `| <40% | ğŸ”´ Poor | Insufficient testing |\n`;
            commentBody += `</details>\n\n`;
            commentBody += `---\n`;
            commentBody += `_Coverage calculated using JaCoCo_`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });
      
      - name: Display coverage summary
        run: |
          echo "## ğŸ“Š Code Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Coverage:** ${{ steps.coverage.outputs.percentage }}% ${{ steps.coverage.outputs.status_emoji }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.coverage.outputs.status_text }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lines Covered | ${{ steps.coverage.outputs.covered }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lines Missed | ${{ steps.coverage.outputs.missed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Total Lines | ${{ steps.coverage.outputs.total }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Coverage %** | **${{ steps.coverage.outputs.percentage }}%** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Threshold:** 70%" >> $GITHUB_STEP_SUMMARY
          echo "**Result:** ${{ steps.coverage.outputs.threshold_passed == 'true' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY

  sonar-quality:
    name: SonarQube Analysis
    needs: test-coverage
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      - name: Build, test, and generate coverage
        run: |
          mvn -B clean verify jacoco:report --batch-mode

      - name: SonarQube analysis (Maven)
        id: sonar
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
          SONAR_ORG: ${{ secrets.SONAR_ORG }}
        run: |
          PR_NUMBER="${{ github.event_name == 'pull_request' && github.event.pull_request.number || '' }}"
          PR_BRANCH="${{ github.head_ref }}"
          PR_BASE="${{ github.base_ref }}"
          EXTRA_ARGS=""
          if [ -n "$SONAR_ORG" ]; then
            EXTRA_ARGS="$EXTRA_ARGS -Dsonar.organization=$SONAR_ORG"
          fi
          if [ -n "$PR_NUMBER" ]; then
            EXTRA_ARGS="$EXTRA_ARGS -Dsonar.pullrequest.key=$PR_NUMBER -Dsonar.pullrequest.branch=$PR_BRANCH -Dsonar.pullrequest.base=$PR_BASE"
          fi
          mvn -B sonar:sonar \
            -Dsonar.projectKey="$SONAR_PROJECT_KEY" \
            -Dsonar.host.url="$SONAR_HOST_URL" \
            -Dsonar.login="$SONAR_TOKEN" \
            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
            -Dsonar.java.binaries=target/classes \
            -Dsonar.scm.provider=git $EXTRA_ARGS

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Wait for Sonar CE task completion
        id: wait-ce
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          TASK_FILE="target/sonar/report-task.txt"
          if [ ! -f "$TASK_FILE" ]; then
            echo "Sonar task file not found at $TASK_FILE"; exit 1;
          fi
          CE_TASK_ID=$(grep 'ceTaskId' "$TASK_FILE" | cut -d'=' -f2)
          echo "CE_TASK_ID=$CE_TASK_ID"
          for i in {1..30}; do
            STATUS=$(curl -s -u "$SONAR_TOKEN:" "${SONAR_HOST_URL}/api/ce/task?id=${CE_TASK_ID}" | jq -r .task.status)
            echo "Status: $STATUS"
            if [ "$STATUS" = "SUCCESS" ]; then break; fi
            if [ "$STATUS" = "FAILED" ]; then echo "Sonar CE failed"; exit 1; fi
            sleep 5
          done

      - name: Fetch coverage from Sonar
        id: sonar-coverage
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
        run: |
          PR_NUMBER="${{ github.event_name == 'pull_request' && github.event.pull_request.number || '' }}"
          if [ -n "$PR_NUMBER" ]; then
            RESP=$(curl -s -u "$SONAR_TOKEN:" "${SONAR_HOST_URL}/api/measures/component?component=${SONAR_PROJECT_KEY}&metricKeys=coverage&pullRequest=${PR_NUMBER}")
          else
            BRANCH="${{ github.ref_name }}"
            RESP=$(curl -s -u "$SONAR_TOKEN:" "${SONAR_HOST_URL}/api/measures/component?component=${SONAR_PROJECT_KEY}&metricKeys=coverage&branch=${BRANCH}")
          fi
          COVERAGE=$(echo "$RESP" | jq -r '.component.measures[0].value // "0.0"')
          echo "coverage=${COVERAGE}" >> "$GITHUB_OUTPUT"
          echo "SonarQube Coverage: ${COVERAGE}%"

      - name: Comment Sonar coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const coverage = '${{ steps.sonar-coverage.outputs.coverage }}';
            const body = `### ğŸ” SonarQube Coverage\n\n**Coverage:** ${coverage}%\n\n_Source: SonarQube analysis for this PR._`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
