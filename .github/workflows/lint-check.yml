name: Code Quality - Lint Check

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
  push:
    branches: main

jobs:
  checkstyle:
    name: Checkstyle Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for diff checking

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run Checkstyle Lint
        uses: tusharkumarshahi/checkstyle-lint-action@v2
        with:
          checkstyle-config: 'google_checks.xml'
          max-errors: 0
          max-warnings: 300
          fail-on-error: true
          check-only-diff: ${{ github.event_name == 'pull_request' }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

  test-coverage:
    name: Test & Coverage
    needs: checkstyle
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'
      
      - name: Run tests with coverage
        id: test
        run: |
          echo "ğŸ§ª Running tests with code coverage..."
          mvn clean test jacoco:report verify --batch-mode
      
      - name: Calculate coverage from JaCoCo XML
        id: coverage
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Calculating Code Coverage"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          COVERAGE_REPORT="target/site/jacoco/jacoco.xml"
          
          if [ ! -f "$COVERAGE_REPORT" ]; then
            echo "âŒ Coverage report not found at $COVERAGE_REPORT"
            exit 1
          fi
          
          # Parse JaCoCo XML to get root-level LINE counters (last occurrence)
          MISSED=$(grep -oP '<counter type="LINE".*?missed="\K[0-9]+' "$COVERAGE_REPORT" | tail -1)
          COVERED=$(grep -oP '<counter type="LINE".*?covered="\K[0-9]+' "$COVERAGE_REPORT" | tail -1)
          
          TOTAL=$((MISSED + COVERED))
          
          if [ $TOTAL -eq 0 ]; then
            PERCENTAGE=0
            echo "âš ï¸  No code to analyze"
          else
            PERCENTAGE=$(awk "BEGIN {printf \"%.2f\", ($COVERED / $TOTAL) * 100}")
          fi
          
          THRESHOLD=70
          
          if (( $(echo "$PERCENTAGE >= 80" | bc -l) )); then
            STATUS_EMOJI="âœ…"
            STATUS_TEXT="Excellent"
            STATUS_COLOR="ğŸŸ¢"
          elif (( $(echo "$PERCENTAGE >= 60" | bc -l) )); then
            STATUS_EMOJI="ğŸ“Š"
            STATUS_TEXT="Good"
            STATUS_COLOR="ğŸŸ¡"
          elif (( $(echo "$PERCENTAGE >= 40" | bc -l) )); then
            STATUS_EMOJI="âš ï¸"
            STATUS_TEXT="Needs Improvement"
            STATUS_COLOR="ğŸŸ "
          else
            STATUS_EMOJI="âŒ"
            STATUS_TEXT="Poor"
            STATUS_COLOR="ğŸ”´"
          fi
          
          echo ""
          echo "ğŸ“ˆ Coverage Metrics:"
          echo "  Lines Covered:    $COVERED"
          echo "  Lines Missed:     $MISSED"
          echo "  Total Lines:      $TOTAL"
          echo "  Coverage:         $PERCENTAGE%"
          echo ""
          echo "$STATUS_COLOR Status: $STATUS_TEXT ($STATUS_EMOJI)"
          echo "  Threshold:        $THRESHOLD%"
          
          if (( $(echo "$PERCENTAGE >= $THRESHOLD" | bc -l) )); then
            echo "  Result:           âœ… Passed"
            THRESHOLD_PASSED=true
          else
            echo "  Result:           âŒ Failed"
            THRESHOLD_PASSED=false
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          echo "percentage=$PERCENTAGE" >> $GITHUB_OUTPUT
          echo "covered=$COVERED" >> $GITHUB_OUTPUT
          echo "missed=$MISSED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "status_emoji=$STATUS_EMOJI" >> $GITHUB_OUTPUT
          echo "status_text=$STATUS_TEXT" >> $GITHUB_OUTPUT
          echo "threshold_passed=$THRESHOLD_PASSED" >> $GITHUB_OUTPUT
      
      - name: Generate coverage badge
        uses: cicirello/jacoco-badge-generator@v2
        with:
          jacoco-csv-file: target/site/jacoco/jacoco.csv
          badges-directory: .github/badges
          generate-branches-badge: true
          generate-coverage-badge: true
      
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: target/site/jacoco/
          retention-days: 7
      
      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const covered = '${{ steps.coverage.outputs.covered }}';
            const missed = '${{ steps.coverage.outputs.missed }}';
            const total = '${{ steps.coverage.outputs.total }}';
            const percentage = '${{ steps.coverage.outputs.percentage }}';
            const statusEmoji = '${{ steps.coverage.outputs.status_emoji }}';
            const statusText = '${{ steps.coverage.outputs.status_text }}';
            
            let commentBody = `## ğŸ“Š Code Coverage Report\n\n`;
            commentBody += `### ${statusEmoji} Coverage: ${percentage}% - ${statusText}\n\n`;
            commentBody += `| Metric | Value |\n`;
            commentBody += `|--------|-------|\n`;
            commentBody += `| **Coverage** | **${percentage}%** |\n`;
            commentBody += `| Lines Covered | ${covered} |\n`;
            commentBody += `| Lines Missed | ${missed} |\n`;
            commentBody += `| Total Lines | ${total} |\n`;
            commentBody += `| Threshold | 70% |\n`;
            commentBody += `| Status | ${'${{ steps.coverage.outputs.threshold_passed }}' === 'true' ? 'âœ… Passed' : 'âŒ Failed'} |\n\n`;
            
            commentBody += `<details>\n`;
            commentBody += `<summary>ğŸ“ˆ Coverage Guidelines</summary>\n\n`;
            commentBody += `| Coverage | Status | Description |\n`;
            commentBody += `|----------|--------|-------------|\n`;
            commentBody += `| 80%+ | ğŸŸ¢ Excellent | Well-tested code |\n`;
            commentBody += `| 60-80% | ğŸŸ¡ Good | Acceptable coverage |\n`;
            commentBody += `| 40-60% | ğŸŸ  Fair | Needs improvement |\n`;
            commentBody += `| <40% | ğŸ”´ Poor | Insufficient testing |\n`;
            commentBody += `</details>\n\n`;
            commentBody += `---\n`;
            commentBody += `_Coverage calculated using JaCoCo_`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });
      
      - name: Display coverage summary
        run: |
          echo "## ğŸ“Š Code Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Coverage:** ${{ steps.coverage.outputs.percentage }}% ${{ steps.coverage.outputs.status_emoji }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.coverage.outputs.status_text }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lines Covered | ${{ steps.coverage.outputs.covered }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lines Missed | ${{ steps.coverage.outputs.missed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Total Lines | ${{ steps.coverage.outputs.total }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Coverage %** | **${{ steps.coverage.outputs.percentage }}%** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Threshold:** 70%" >> $GITHUB_STEP_SUMMARY
          echo "**Result:** ${{ steps.coverage.outputs.threshold_passed == 'true' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
