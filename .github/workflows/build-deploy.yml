name: Build & Deploy to JFrog

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:  # Manual trigger

env:
  JAVA_VERSION: '21'
  MAVEN_OPTS: -Xmx1024m
  DOCKER_REGISTRY: ${{ secrets.JFROG_DOCKER_REGISTRY }}  # e.g., yourserver.jfrog.io/taskmaster-docker

jobs:
  build-and-deploy:
    name: Build & Deploy Artifacts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better versioning

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Extract version from pom.xml
        id: version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Building version: $VERSION"

      - name: Build with Maven
        run: |
          echo "ðŸ”¨ Building project..."
          mvn -B clean package -DskipTests
          echo "âœ… Build completed successfully"

      - name: Run tests
        run: |
          echo "ðŸ§ª Running tests..."
          mvn -B test
          echo "âœ… Tests passed"

      - name: Generate build info
        id: build-info
        run: |
          BUILD_NUMBER=${{ github.run_number }}
          COMMIT_SHA=${{ github.sha }}
          COMMIT_SHORT=${COMMIT_SHA:0:7}
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          BUILD_TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "commit_short=$COMMIT_SHORT" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "timestamp=$BUILD_TIMESTAMP" >> $GITHUB_OUTPUT
          
          echo "ðŸ“Š Build Info:"
          echo "  - Version: ${{ steps.version.outputs.version }}"
          echo "  - Build: #$BUILD_NUMBER"
          echo "  - Commit: $COMMIT_SHORT"
          echo "  - Branch: $BRANCH_NAME"
          echo "  - Timestamp: $BUILD_TIMESTAMP"

      - name: Create settings.xml with JFrog credentials
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << 'EOF'
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                                        https://maven.apache.org/xsd/settings-1.0.0.xsd">
            <servers>
              <server>
                <id>jfrog-artifactory</id>
                <username>${{ secrets.JFROG_USERNAME }}</username>
                <password>${{ secrets.JFROG_ACCESS_TOKEN }}</password>
              </server>
            </servers>
          </settings>
          EOF
          echo "âœ… Maven settings.xml configured with JFrog credentials"

      - name: Deploy to JFrog Artifactory
        env:
          JFROG_URL: ${{ secrets.JFROG_URL }}
        run: |
          echo "ðŸš€ Deploying artifacts to JFrog Artifactory..."
          echo "  Target: $JFROG_URL"
          echo "  Version: ${{ steps.version.outputs.version }}"
          
          mvn -B deploy -DskipTests
          
          if [ $? -eq 0 ]; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Deployment failed!"
            exit 1
          fi

      - name: Verify deployment
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          REPO_PATH="taskmaster-maven-local"
          ARTIFACT_URL="${{ secrets.JFROG_URL }}/$REPO_PATH/com/example/taskmaster/$VERSION/"
          
          echo "âœ… Deployed: taskmaster-$VERSION â†’ JFrog Artifactory"
          echo "ðŸ“ Repository: $REPO_PATH"
          echo "ðŸ”— URL: $ARTIFACT_URL"

      - name: Build Docker image
        run: |
          echo "ðŸ³ Building Docker image..."
          docker build -t taskmaster:${{ steps.version.outputs.version }} .
          docker tag taskmaster:${{ steps.version.outputs.version }} \
            ${{ env.DOCKER_REGISTRY }}/taskmaster:${{ steps.version.outputs.version }}
          docker tag taskmaster:${{ steps.version.outputs.version }} \
            ${{ env.DOCKER_REGISTRY }}/taskmaster:latest
          echo "âœ… Docker image built successfully"

      - name: Login to JFrog Docker Registry
        run: |
          echo "ðŸ” Logging into JFrog Docker Registry..."
          echo "${{ secrets.JFROG_ACCESS_TOKEN }}" | docker login ${{ env.DOCKER_REGISTRY }} \
            -u ${{ secrets.JFROG_USERNAME }} \
            --password-stdin
          echo "âœ… Logged in successfully"

      - name: Push Docker image to JFrog
        run: |
          echo "ðŸ“¤ Pushing Docker image to JFrog..."
          docker push ${{ env.DOCKER_REGISTRY }}/taskmaster:${{ steps.version.outputs.version }}
          docker push ${{ env.DOCKER_REGISTRY }}/taskmaster:latest
          echo "âœ… Docker image pushed successfully"

      - name: Docker image info
        id: docker-info
        run: |
          IMAGE_SIZE=$(docker images ${{ env.DOCKER_REGISTRY }}/taskmaster:${{ steps.version.outputs.version }} --format "{{.Size}}")
          echo "size=$IMAGE_SIZE" >> $GITHUB_OUTPUT
          echo "ðŸ“Š Image size: $IMAGE_SIZE"

      - name: Create deployment summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ“¦ Deployment Successful
          
          **Version:** `${{ steps.version.outputs.version }}` | **Build:** `#${{ steps.build-info.outputs.build_number }}` | **Commit:** `${{ steps.build-info.outputs.commit_short }}`
          
          ### JAR Artifact
          - **Repository:** `taskmaster-maven-local`
          - **Type:** ${{ contains(steps.version.outputs.version, 'SNAPSHOT') && 'Snapshot' || 'Release' }}
          
          ### Docker Image
          - **Registry:** `${{ env.DOCKER_REGISTRY }}`
          - **Image:** `taskmaster:${{ steps.version.outputs.version }}`
          - **Size:** `${{ steps.docker-info.outputs.size }}`
          - **Tags:** `${{ steps.version.outputs.version }}`, `latest`
          
          **Pull command:**
          ```bash
          docker pull ${{ env.DOCKER_REGISTRY }}/taskmaster:${{ steps.version.outputs.version }}
          ```
          
          **Run command:**
          ```bash
          docker run -p 8080:8080 ${{ env.DOCKER_REGISTRY }}/taskmaster:latest
          ```
          
          [View in JFrog](${{ secrets.JFROG_URL }}) â€¢ [Commit](${{ github.server_url }}/${{ github.repository }}/commit/${{ steps.build-info.outputs.commit_sha }})
          EOF
