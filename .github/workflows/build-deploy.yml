name: Build & Deploy to JFrog

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:  # Manual trigger

env:
  JAVA_VERSION: '21'
  MAVEN_OPTS: -Xmx1024m
  DOCKER_REGISTRY: ${{ secrets.JFROG_DOCKER_REGISTRY }}  # e.g., yourserver.jfrog.io/taskmaster-docker

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: Build & Deploy JAR
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-and-deploy-jar:
    name: Build & Deploy JAR
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better versioning

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Extract version from pom.xml
        id: version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Building version: $VERSION"

      - name: Build with Maven
        run: |
          echo "ðŸ”¨ Building project..."
          mvn -B clean package -DskipTests
          echo "âœ… Build completed successfully"

      - name: Run tests
        run: |
          echo "ðŸ§ª Running tests..."
          mvn -B test
          echo "âœ… Tests passed"

      - name: Generate build info
        id: build-info
        run: |
          BUILD_NUMBER=${{ github.run_number }}
          COMMIT_SHA=${{ github.sha }}
          COMMIT_SHORT=${COMMIT_SHA:0:7}
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          BUILD_TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "commit_short=$COMMIT_SHORT" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "timestamp=$BUILD_TIMESTAMP" >> $GITHUB_OUTPUT
          
          echo "ðŸ“Š Build Info:"
          echo "  - Version: ${{ steps.version.outputs.version }}"
          echo "  - Build: #$BUILD_NUMBER"
          echo "  - Commit: $COMMIT_SHORT"
          echo "  - Branch: $BRANCH_NAME"
          echo "  - Timestamp: $BUILD_TIMESTAMP"

      - name: Create settings.xml with JFrog credentials
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << 'EOF'
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                                        https://maven.apache.org/xsd/settings-1.0.0.xsd">
            <servers>
              <server>
                <id>jfrog-artifactory</id>
                <username>${{ secrets.JFROG_USERNAME }}</username>
                <password>${{ secrets.JFROG_ACCESS_TOKEN }}</password>
              </server>
            </servers>
          </settings>
          EOF
          echo "âœ… Maven settings.xml configured with JFrog credentials"

      - name: Deploy to JFrog Artifactory
        env:
          JFROG_URL: ${{ secrets.JFROG_URL }}
        run: |
          echo "ðŸš€ Deploying artifacts to JFrog Artifactory..."
          echo "  Target: $JFROG_URL"
          echo "  Version: ${{ steps.version.outputs.version }}"
          
          mvn -B deploy -DskipTests
          
          if [ $? -eq 0 ]; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Deployment failed!"
            exit 1
          fi

      - name: Verify deployment
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          REPO_PATH="taskmaster-maven-local"
          ARTIFACT_URL="${{ secrets.JFROG_URL }}/$REPO_PATH/com/example/taskmaster/$VERSION/"
          
          echo "âœ… Deployed: taskmaster-$VERSION â†’ JFrog Artifactory"
          echo "ðŸ“ Repository: $REPO_PATH"
          echo "ðŸ”— URL: $ARTIFACT_URL"

      - name: Upload JAR for Docker build
        uses: actions/upload-artifact@v4
        with:
          name: application-jar
          path: target/taskmaster-*.jar
          retention-days: 1

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: Build Docker Image
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-docker-image:
    name: Build Docker Image
    needs: build-and-deploy-jar
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: application-jar
          path: target/

      - name: Extract version from filename
        id: version
        run: |
          JAR_FILE=$(ls target/taskmaster-*.jar | head -1)
          VERSION=$(basename "$JAR_FILE" | sed 's/taskmaster-//;s/.jar//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: $VERSION"

      - name: Build Docker image
        run: |
          echo "ðŸ³ Building Docker image..."
          docker build -t taskmaster:${{ steps.version.outputs.version }} .
          echo "âœ… Docker image built successfully"

      - name: Save Docker image
        run: |
          echo "ðŸ’¾ Saving Docker image..."
          docker save taskmaster:${{ steps.version.outputs.version }} -o taskmaster-image.tar
          echo "âœ… Image saved"

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: taskmaster-image.tar
          retention-days: 1

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: Security Scan (Snyk Container)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  security-scan:
    name: Container Security Scan
    needs: build-docker-image
    runs-on: ubuntu-latest
    
    steps:
      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        id: load
        run: |
          echo "ðŸ“¦ Loading Docker image..."
          docker load -i taskmaster-image.tar
          IMAGE_NAME=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep taskmaster | head -1)
          echo "image=$IMAGE_NAME" >> $GITHUB_OUTPUT
          echo "âœ… Loaded: $IMAGE_NAME"

      - name: Install Snyk CLI
        run: |
          echo "ðŸ“¦ Installing Snyk CLI..."
          npm install -g snyk
          snyk --version

      - name: Authenticate with Snyk
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          snyk auth $SNYK_TOKEN
          echo "âœ… Authenticated with Snyk"

      - name: Scan Docker image with Snyk
        id: snyk-scan
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          echo "ðŸ” Scanning Docker image for vulnerabilities..."
          
          # Install jq for JSON parsing
          sudo apt-get update -qq && sudo apt-get install -y jq
          
          # Run Snyk container test and capture results
          snyk container test ${{ steps.load.outputs.image }} \
            --json \
            --severity-threshold=high \
            > snyk-container-report.json || true
          
          # Parse results
          VULNERABILITIES=$(jq -r '.uniqueCount // 0' snyk-container-report.json)
          CRITICAL=$(jq -r '[.vulnerabilities[] | select(.severity == "critical")] | length' snyk-container-report.json)
          HIGH=$(jq -r '[.vulnerabilities[] | select(.severity == "high")] | length' snyk-container-report.json)
          MEDIUM=$(jq -r '[.vulnerabilities[] | select(.severity == "medium")] | length' snyk-container-report.json)
          LOW=$(jq -r '[.vulnerabilities[] | select(.severity == "low")] | length' snyk-container-report.json)
          BASE_IMAGE=$(jq -r '.docker.baseImage // "unknown"' snyk-container-report.json)
          
          # Output for summary
          echo "vulnerabilities=$VULNERABILITIES" >> $GITHUB_OUTPUT
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT
          echo "base_image=$BASE_IMAGE" >> $GITHUB_OUTPUT
          
          # Display results
          echo "ðŸ“Š Container Scan Results:"
          echo "  Base Image: $BASE_IMAGE"
          echo "  Critical: $CRITICAL"
          echo "  High: $HIGH"
          echo "  Medium: $MEDIUM"
          echo "  Low: $LOW"
          echo "  Total: $VULNERABILITIES"
          
          # Fail if critical vulnerabilities found
          if [ "$CRITICAL" -gt 0 ]; then
            echo "âŒ CRITICAL vulnerabilities found! Blocking deployment."
            echo "ðŸ“„ See detailed report in artifacts"
            exit 1
          fi
          
          if [ "$HIGH" -gt 0 ]; then
            echo "âš ï¸  HIGH severity vulnerabilities found, but continuing..."
          else
            echo "âœ… No critical or high vulnerabilities found"
          fi

      - name: Upload Snyk report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: snyk-container-report
          path: snyk-container-report.json
          retention-days: 30

      - name: Create security summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ”’ Container Security Scan
          
          **Image:** `${{ steps.load.outputs.image }}`
          **Base Image:** `${{ steps.snyk-scan.outputs.base_image }}`
          
          | Severity | Count |
          |----------|-------|
          | ðŸ”´ Critical | ${{ steps.snyk-scan.outputs.critical }} |
          | ðŸŸ  High | ${{ steps.snyk-scan.outputs.high }} |
          | ðŸŸ¡ Medium | ${{ steps.snyk-scan.outputs.medium }} |
          | ðŸŸ¢ Low | ${{ steps.snyk-scan.outputs.low }} |
          | **Total** | **${{ steps.snyk-scan.outputs.vulnerabilities }}** |
          
          **Status:** ${{ steps.snyk-scan.outputs.critical == '0' && 'âœ… Passed' || 'âŒ Failed' }}
          EOF

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 4: Push to JFrog Registry
  # Only runs if security scan passes
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  push-to-registry:
    name: Push to JFrog
    needs: [build-docker-image, security-scan]
    runs-on: ubuntu-latest
    
    steps:
      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        id: load
        run: |
          echo "ðŸ“¦ Loading Docker image..."
          docker load -i taskmaster-image.tar
          IMAGE_NAME=$(docker images --format "{{.Repository}}:{{.Tag}load.outputs.version }}
          docker push ${{ env.DOCKER_REGISTRY }}/taskmaster:latest
          echo "âœ… Docker image pushed successfully"

      - name: Get image info
        id: image-info
        run: |
          IMAGE_SIZE=$(docker images "${{ env.DOCKER_REGISTRY }}/taskmaster:${{ steps.load.outputs.version }}" --format "{{.Size}}")
          echo "size=$IMAGE_SIZE" >> $GITHUB_OUTPUT

      - name: Create deployment summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸš€ Docker Image Deployed
          
          **Version:** `${{ steps.load.outputs.version }}`
          **Registry:** `${{ env.DOCKER_REGISTRY }}`
          **Size:** `${{ steps.image-info.outputs.size }}`
          **Tags:** `${{ steps.load.outputs.version }}`, `latest`
          
          ### Pull & Run Commands
          ```bash
          # Pull image
          docker pull ${{ env.DOCKER_REGISTRY }}/taskmaster:${{ steps.load.outputs.version }}
          
          # Run container
          docker run -p 8080:8080 ${{ env.DOCKER_REGISTRY }}/taskmaster:latest
          ```
          
          [View in JFrog](${{ secrets.JFROG_URL
          retention-days: 30

      - name: Login to JFrog Docker Registry
        run: |
          echo "ðŸ” Logging into JFrog Docker Registry..."
          echo "${{ secrets.JFROG_ACCESS_TOKEN }}" | docker login ${{ env.DOCKER_REGISTRY }} \
            -u ${{ secrets.JFROG_USERNAME }} \
            --password-stdin
          echo "âœ… Logged in successfully"

      - name: Push Docker image to JFrog
        run: |
          echo "ðŸ“¤ Pushing Docker image to JFrog..."
          docker push ${{ env.DOCKER_REGISTRY }}/taskmaster:${{ steps.version.outputs.version }}
          docker push ${{ env.DOCKER_REGISTRY }}/taskmaster:latest
          echo "âœ… Docker image pushed successfully"

      - name: Docker image info
        id: docker-info
        run: |
          IMAGE_SIZE=$(docker images ${{ env.DOCKER_REGISTRY }}/taskmaster:${{ steps.version.outputs.version }} --format "{{.Size}}")
          echo "size=$IMAGE_SIZE" >> $GITHUB_OUTPUT
          echo "ðŸ“Š Image size: $IMAGE_SIZE"

      - name: Create deployment summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ“¦ Deployment Successful
          
          **Version:** `${{ steps.version.outputs.version }}` | **Build:** `#${{ steps.build-info.outputs.build_number }}` | **Commit:** `${{ steps.build-info.outputs.commit_short }}`
          
          ### JAR Artifact
          - **Repository:** `taskmaster-maven-local`
          - **Type:** ${{ contains(steps.version.outputs.version, 'SNAPSHOT') && 'Snapshot' || 'Release' }}
          
          ### Docker Image
          - **Registry:** `${{ env.DOCKER_REGISTRY }}`
          - **Image:** `taskmaster:${{ steps.version.outputs.version }}`
          - **Size:** `${{ steps.docker-info.outputs.size }}`
          - **Tags:** `${{ steps.version.outputs.version }}`, `latest`
          
          ### Security Scan
          - **Base Image:** `${{ steps.snyk-container.outputs.base_image }}`
          - **Critical:** ${{ steps.snyk-container.outputs.critical }} | **High:** ${{ steps.snyk-container.outputs.high }} | **Medium:** ${{ steps.snyk-container.outputs.medium }} | **Low:** ${{ steps.snyk-container.outputs.low }}
          - **Total Vulnerabilities:** ${{ steps.snyk-container.outputs.vulnerabilities }}
          
          **Pull command:**
          ```bash
          docker pull ${{ env.DOCKER_REGISTRY }}/taskmaster:${{ steps.version.outputs.version }}
          ```
          
          **Run command:**
          ```bash
          docker run -p 8080:8080 ${{ env.DOCKER_REGISTRY }}/taskmaster:latest
          ```
          
          [View in JFrog](${{ secrets.JFROG_URL }}) â€¢ [Commit](${{ github.server_url }}/${{ github.repository }}/commit/${{ steps.build-info.outputs.commit_sha }})
          EOF
